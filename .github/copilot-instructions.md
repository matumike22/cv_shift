# CV Shift â€” AI Assistant Instructions

Quick, focused guidance to help AI coding agents contribute effectively to this repository.

## ðŸ§­ Big picture
- Flutter app (Material + GoRouter) with **Firebase backend** (Auth + Firestore) and **AI CV generation** (Firebase AI / Gemini via `lib/repo/cv_ai_service.dart`).
- Key domains: **accounts** (`accounts` Firestore collection) and **cv_data** (`cv_data` Firestore collection).
- State is wired with **Riverpod** providers (`lib/repo/state_providers.dart`) and UI routing & auth/account gating lives in `lib/router.dart`.

## ðŸ”§ How to run & test
- Common commands:
  - Install deps: `flutter pub get`
  - Run (web): `flutter run -d chrome` (web is configured out-of-the-box)
  - Run tests: `flutter test`
  - Static analysis: `flutter analyze`
- Note: `lib/firebase_options.dart` is generated by FlutterFire and **only the web config is populated** in this checkout. Reconfigure other platforms with the FlutterFire CLI if needed.

## ðŸ—‚ Key files & patterns (refer to these when making changes)
- Routing & auth gating: `lib/router.dart` â€” redirects to `LoginPage` if `authStateProvider` is null, to `SetAccountPage` if account is missing.
- Providers: `lib/repo/state_providers.dart` â€” central place for auth/account/CV providers; keep business logic in `repo/` classes where possible.
- Firebase wrappers: `lib/repo/*_repo.dart` (e.g. `AccountRepo`, `CvDataRepo`, `AuthRepo`) â€” follow their error-handling style (user-facing string messages via `custom_exceptio_errors.dart`).
- AI integration: `lib/repo/cv_ai_service.dart` â€” contains the prompt, model selection (`gemini-2.5-flash`), and a strict JSON sanitizer. If changing the prompt or model, update prompt rules and keep sanitizer in sync.
- Models: `lib/repo/models/*.dart` â€” `Account` and `CvData` define the Firestore shape and serialization helpers.

## ðŸ§ª Tests & test expectations
- Tests are standard Flutter widget tests (`test/widget_test.dart`). Note the example test pumps `MyApp()`; if you introduce Firebase-dependent start-up logic in tests, provide mocks or use `firebase_auth_mocks` / injection to avoid flakiness.

## ðŸš¨ Error handling & conventions
- Repo classes catch Firebase exceptions and map them to friendly messages via `lib/repo/custom_exceptio_errors.dart`. New code interacting with Firebase should reuse these helpers for consistent UX.
- Many methods throw plain strings or `Exception(...)` with user-facing text â€” follow this pattern for consistency, but prefer typed exceptions where broader refactors are happening.

## ðŸ§  AI & prompt-specific notes
- `CvAiService._buildPrompt` enforces a strict output: **the model must return ONLY valid JSON** matching the schema in the prompt. The sanitizer (`_sanitizeJson`) extracts the first valid JSON object.
- When editing the prompt:
  - Preserve explicit `RULES` and `OUTPUT FORMAT` blocks.
  - Update sanitizer if you broaden allowed output formats.

## ðŸ”— Integration touchpoints
- Firestore collections used:
  - `accounts` (see `AccountRepo`)
  - `cv_data` (see `CvDataRepo`)
- Auth: `FirebaseAuth` via `AuthRepo` + `authStateProvider`.
- Generative AI: Firebase AI SDK (see `pubspec.yaml` for dependency; prompt and model selection live in `CvAiService`).

## âœ… PR & change guidance for AI agents
- Small, focused PRs: 1 logical change per PR.
- When touching AI prompts or model selection, include:
  - Short rationale and expected output changes.
  - Unit or integration test demonstrating the sanitized output or error behavior.
- When changing Firestore shapes, update model classes in `lib/repo/models/` and ensure serialization is backward-compatible.

---
Got feedback or want clarifications on any section? Tell me what to expand or a sample task (bugfix/feature) and I'll iterate the instructions accordingly.